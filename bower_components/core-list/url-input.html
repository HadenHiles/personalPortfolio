<!DOCTYPE html>
<html>
<head>
    <title>Url Input</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="../platform/platform.js"></script>
    <link rel="import" href="../core-ajax/core-ajax.html">
    <link rel="import" href="../paper-input/paper-input.html">
    <link rel="import" href="../paper-fab/paper-fab.html">
    <style>
        CoreStyle.g.paperInput.focusedColor {
            color : green;
        }

        CoreStyle.g.paperInput.invalidColor {
            color : red;
        }
    </style>
</head>
<body>
<polymer-element name="url-element" attributes="url, jQuery">
    <template>
        <paper-input floatingLabel label="Enter a URL" type="url" pattern="https?://.+" error="Input is not a URL!"
                     value="{{url}}"></paper-input>
        <!--<paper-fab icon="favorite" class="mini" on-tap="{{go}}"></paper-fab>-->
        <core-ajax id="ajax" auto
                url="{{proxifyUrl(url)}}"
                handleAs="document"
                on-core-response="{{handleResponse}}">
                </core-ajax>
        <iframe>{{sourceDocument}}</iframe>
        <div>{{sourceDocument}}</div>
        <p>{{url}}</p>
        <template repeat="{{url in gameUrls(sourceDocument)}}">
            <p>{{url}}</p>
        </template>
    </template>
</polymer-element>
<url-element></url-element>
<script>
    Polymer('url-element', {
        ready: function () {
            this.url = location.href;
            this.sourceDocument = "todd really does rock; says Haden!";
        },
        proxifyUrl : function(url){
            var proxyUrl = "";
            if(url !== undefined && url != ""){
                proxyUrl = location.origin + "/proxy.php?q=" + btoa(url);
            }
            return proxyUrl;
        },
        handleResponse: function (e) {
            this.sourceDocument = e.detail.response;
        },
        elementSelector : 'object embed[src], object[data]',
        gameUrls : function(document) {
            var jDoc = $(document);
            var gameUrls = [];
            var originalUrl;
            var goodUrl;
            jDoc.find(this.elementSelector).each(function (e) {
                originalUrl = $(this).attr('src') || $(this).attr('data');
                if (/^http/i.test(originalUrl)) {
                    //continue
                    goodUrl = originalUrl;
                } else if (/^\//i.test(originalUrl)) {
                    goodUrl = location.protocol + '//' + location.host + originalUrl;
                } else {
                    goodUrl = location.href.substr(0, location.href.lastIndexOf("/") + 1) + originalUrl;
                }
                gameUrls.push(goodUrl);
            });
            return gameUrls;
        }
        });
</script>
</body>
</html>